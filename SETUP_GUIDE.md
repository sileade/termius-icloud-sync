# Пошаговый гайд по настройке синхронизации Termius и iCloud

**Автор:** Manus AI
**Версия:** 1.0.0

Этот гайд поможет вам шаг за шагом настроить автоматическую синхронизацию SSH-конфигурации между iCloud Drive и Termius на вашем Mac. В результате вы получите единый источник правды для ваших SSH-хостов, который будет работать как в стандартных терминалах, так и в Termius.

## Шаг 0: Подготовка

Перед началом убедитесь, что ваша система соответствует требованиям.

### 1. Проверьте версию macOS

Система требует **macOS 12.0 (Monterey)** или новее. Чтобы проверить вашу версию, откройте меню Apple () в левом верхнем углу и выберите «Об этом Mac».

### 2. Установите Homebrew

Homebrew — это менеджер пакетов для macOS. Если у вас его нет, откройте **Терминал** и выполните команду:

```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

### 3. Установите Termius и Termius CLI

Если у вас еще не установлен Termius, скачайте его с [официального сайта](https://termius.com/) или из App Store. Затем установите утилиту командной строки (CLI) через Homebrew:

```bash
brew install termius
```

После установки войдите в свой аккаунт Termius через CLI:

```bash
termius login
```

### 4. Включите iCloud Drive

Убедитесь, что iCloud Drive включен и работает. Откройте **Системные настройки** → **Apple ID** → **iCloud** и проверьте, что **iCloud Drive** активен.

## Шаг 1: Получение скриптов

Вам нужно скачать проект с GitHub.

1.  **Откройте Терминал**.
2.  **Клонируйте репозиторий** с помощью команды `gh` (GitHub CLI) или `git`:

    **С помощью `gh` (рекомендуется):**
    ```bash
    gh repo clone sileade/termius-icloud-sync
    ```

    **С помощью `git`:**
    ```bash
    git clone https://github.com/sileade/termius-icloud-sync.git
    ```

3.  **Перейдите в созданную директорию**:
    ```bash
    cd termius-icloud-sync
    ```

## Шаг 2: Интерактивная установка

В репозитории есть скрипт `install.sh`, который сделает всю сложную работу за вас. Он задаст несколько вопросов и настроит систему.

1.  **Запустите скрипт установки**:
    ```bash
    ./install.sh
    ```

2.  **Следуйте инструкциям на экране**.

    *   **Проверка зависимостей**: Скрипт проверит, установлен ли `termius`.
    *   **Выбор директории в iCloud**: Вам будет предложено указать, где в iCloud Drive вы хотите хранить SSH-конфиг. Рекомендуется создать отдельную папку, например, `SSH` или `dotfiles`.
        *   *Пример:* `~/Library/Mobile Documents/com~apple~CloudDocs/SSH`
    *   **Создание симлинка**: Скрипт предложит создать символическую ссылку (симлинк) `~/.ssh/config` на ваш новый файл в iCloud. Это ключевой шаг, который позволит всем вашим терминалам использовать один и тот же файл.
        *   Если у вас уже есть файл `~/.ssh/config`, скрипт предложит создать его резервную копию.
    *   **Установка LaunchAgent**: Скрипт установит специальный файл `.plist` в директорию `~/Library/LaunchAgents/`. Это позволит macOS автоматически запускать скрипт импорта при каждом изменении вашего конфига в iCloud.

После завершения установки система будет полностью настроена.

## Шаг 3: Проверка работы

Теперь давайте убедимся, что все работает как надо.

### Проверка импорта (iCloud → Termius)

1.  **Откройте ваш SSH-конфиг** в любом текстовом редакторе. Если вы создали симлинк, просто выполните:
    ```bash
    open ~/.ssh/config
    ```

2.  **Добавьте новый хост**. Например:
    ```ssh-config
    Host test-import-host
        HostName 192.168.10.1
        User testuser
    ```

3.  **Сохраните файл**.

4.  **Подождите 10-15 секунд**. `launchd` должен заметить изменение и запустить скрипт импорта.

5.  **Откройте Termius**. В списке хостов вы должны увидеть новый хост `test-import-host`.

### Проверка игнорирования

1.  **Снова откройте конфиг** `~/.ssh/config`.

2.  **Добавьте еще один хост**, но на этот раз с маркером `# termius:ignore`:
    ```ssh-config
    Host test-ignored-host
        # termius:ignore
        HostName 192.168.10.2
        User ignoreduser
    ```

3.  **Сохраните файл**.

4.  **Проверьте Termius**. Хост `test-ignored-host` **не должен** появиться в списке.

### Проверка экспорта (Termius → iCloud)

1.  **Откройте приложение Termius** и добавьте новый хост вручную. Назовем его `test-export-from-termius`.

2.  **Откройте Терминал** и выполните команду:
    ```bash
    termius-export-to-icloud.sh
    ```

3.  **Откройте ваш файл `~/.ssh/config`**. Вы должны увидеть, что в него добавился хост `test-export-from-termius`. При этом `test-ignored-host` должен был остаться на месте.

## Шаг 4: Повседневное использование

*   **Для добавления/изменения хостов** просто редактируйте файл `~/.ssh/config`. Изменения автоматически появятся в Termius.
*   **Если нужно добавить хост только для Termius**, делайте это через приложение Termius, а затем запускайте `termius-export-to-icloud.sh`, чтобы синхронизировать изменения обратно в iCloud.
*   **Для локальных или секретных хостов**, которые не должны быть в Termius, всегда используйте маркер `# termius:ignore`.

## Устранение неполадок

*   **Импорт не работает**: Проверьте логи в `~/.local/log/termius-sync/`. Возможно, есть ошибка в синтаксисе конфига.
*   **`launchd` не запускается**: Попробуйте перезагрузить агент:
    ```bash
    launchctl unload ~/Library/LaunchAgents/com.user.termius-import.plist
    launchctl load ~/Library/LaunchAgents/com.user.termius-import.plist
    ```
*   **Команда не найдена**: Убедитесь, что `~/.local/bin` добавлен в ваш `PATH`. Скрипт установки делает это для `.zshrc` и `.bash_profile`.

Поздравляем! Ваша система синхронизации настроена и готова к работе.
